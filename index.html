<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> 
<title>çœŸå¯¦ç‰©ç†æ²™ç›’ - åº•éƒ¨ç©ºé–“å„ªåŒ–ç‰ˆ</title>
<style>
/* ç¢ºä¿ body å¡«æ»¿è¦–å£ä¸¦ç¦æ­¢æ»¾å‹• */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #0b0b0b;
}

body{
  color:#ccc;
  font-family:Consolas;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* ç¸½æ§åˆ¶å€ï¼šé™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œä¸¦ç¢ºä¿å…¶å¯¬åº¦èˆ‡ç•«å¸ƒåŒæ­¥ */
#controls {
    width: 95%; 
    max-width: 900px;
}
/* ç­†åˆ·èˆ‡æ¨¡å¼æ§åˆ¶ï¼šé ‚éƒ¨ flex ä½ˆå±€ */
#top-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 5px; 
}
#brush-controls {
    display: flex;
    align-items: center;
    gap: 8px; 
}

/* æ¨¡å¼æŒ‰éˆ•æ¨£å¼ */
#crazy-mode-button {
    background-color: #ff4500;
    color: white;
    font-weight: bold;
    padding: 6px 10px; 
}
#crazy-mode-button.active {
    background-color: #4CAF50;
    animation: flash 0.5s infinite alternate; 
}
@keyframes flash {
    from {box-shadow: 0 0 10px #ff4500;}
    to {box-shadow: 0 0 20px #ff4500;}
}

/* æ»‘å‹•å®¹å™¨æ¨£å¼ï¼šç”¨æ–¼å…ƒç´ æŒ‰éˆ• */
#ui-container {
  overflow-x: auto; 
  margin: 4px 0 8px 0; 
  white-space: nowrap; 
  padding-bottom: 5px; 
}

/* æŒ‰éˆ•å®¹å™¨ */
#ui-scroll{
  display: flex; 
  gap: 5px; 
  padding: 0 5px; 
}

/* èª¿æ•´æŒ‰éˆ•å¤§å° */
button{
  padding: 6px 10px; 
  border: none;
  cursor: pointer;
  color: #fff;
  font-size: 13px; 
  min-width: 80px; 
  max-width: 120px; 
  white-space: normal; 
  height: auto; 
  line-height: 1.1;
  box-sizing: border-box;
  display: inline-block; 
}

button.active{outline:2px solid #00e0ff}

/* å°è©±/è¨Šæ¯æ—¥èªŒå€åŸŸ */
#game-log {
    position: fixed;
    bottom: 30px;
    right: 20px;
    width: 300px;
    max-height: 150px;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid #444;
    padding: 10px;
    font-size: 12px;
    pointer-events: none;
    display: flex;
    flex-direction: column-reverse;
    border-radius: 8px;
    z-index: 100;
}
.log-msg {
    margin-bottom: 4px;
    border-bottom: 1px solid #222;
    padding-bottom: 2px;
    animation: fadeIn 0.2s;
}
.log-name { font-weight: bold; color: #4db8ff; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* FPS è¨ˆæ•¸å™¨ */
#fps-counter {
    position: fixed;
    top: 10px;
    right: 10px;
    color: #00ff00;
    font-family: monospace;
    font-size: 14px;
    z-index: 1000;
    pointer-events: none;
}

/* ç•«å¸ƒæ¨£å¼ï¼šä½”æ“šæ‰€æœ‰å‰©é¤˜ç©ºé–“ */
canvas{
  border:3px solid #444;
  image-rendering:pixelated;
  touch-action:none; 
  /* ç¢ºä¿åº•éƒ¨æœ‰è¶³å¤ çš„é‚Šè·ï¼Œé˜²æ­¢è¢«å¹³æ¿ç³»çµ±UIé®æ“‹ */
  margin-bottom: 10px; 
  /* ç¦æ­¢ Flex è‡ªå‹•æ‹‰ä¼¸å°è‡´åº§æ¨™åç§» */
  flex-grow: 0;
  flex-shrink: 0;
}
</style>
</head>
<body>

<div id="controls">
    <div id="top-controls">
        <div id="brush-controls">
            <span>ç­†åˆ·å¤§å°:</span>
            <input id="brush" type="range" min="1" max="5" value="1">
            <span id="bval">1</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button id="clear-btn" style="background:#cc3333;">å…¨éƒ¨æ¸…é™¤</button>
            <button id="fullscreen-btn" style="background:#3366cc;">å…¨è¢å¹•</button>
            <button id="crazy-mode-button">ç˜‹ç‹‚æ¨¡å¼</button>
        </div>
    </div>
    
    <div id="ui-container">
        <div id="ui-scroll">
            </div>
    </div>
</div>

<canvas id="c"></canvas>
<div id="game-log"></div>
<div id="fps-counter">FPS: 0</div>

<script>
/* ===== åŸºæœ¬è¨­å®šèˆ‡å‹•æ…‹å°ºå¯¸è¨ˆç®— (åº•éƒ¨ç©ºé–“å„ªåŒ–) ===== */
const SIZE = 4;
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
let COLS, ROWS;
let imgData, data; // å…¨å±€è®Šé‡ï¼Œé¿å…æ¯å¹€å‰µå»º

const controls = document.getElementById('controls');

function resizeCanvas() {
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // 1. å…ˆè¨ˆç®—ä¸¦è¨­ç½®å¯¬åº¦ï¼Œé€™æ¨£ controls çš„é«˜åº¦æ‰æœƒæº–ç¢ºï¼ˆå› ç‚ºå…§å®¹å¯èƒ½æ›è¡Œï¼‰
    const availableWidth = viewportWidth * 0.95; 
    let newWidth = Math.floor(availableWidth / SIZE) * SIZE;
    if (newWidth > 900) newWidth = 900;
    
    // æ‡‰ç”¨å¯¬åº¦åˆ°æ§åˆ¶åˆ—
    controls.style.width = newWidth + 'px';
    
    // 2. ç²å–èª¿æ•´å¯¬åº¦å¾Œçš„ controls é«˜åº¦
    const controlsHeight = controls.offsetHeight;
    
    // 3. è¨ˆç®—å¯ç”¨é«˜åº¦
    // æ¸›å» controlsHeight
    // æ¸›å» margin-bottom (10px)
    // æ¸›å» border (3px top + 3px bottom = 6px)
    // æ¸›å» é¡å¤–ç·©è¡ (buffer = 20px)
    const marginBottom = 10;
    const border = 6;
    const buffer = 20;
    
    const availableHeight = viewportHeight - controlsHeight - marginBottom - border - buffer; 

    // ç¢ºå®šç•«å¸ƒé«˜åº¦
    let newHeight = Math.floor(availableHeight / SIZE) * SIZE;

    // é™åˆ¶æœ€å°é«˜åº¦
    if (newHeight < 100) newHeight = 100;

    canvas.width = newWidth;
    canvas.height = newHeight;
    
    // å¼·åˆ¶è¨­å®š CSS å°ºå¯¸èˆ‡å±¬æ€§å°ºå¯¸ä¸€è‡´ï¼Œé˜²æ­¢ç€è¦½å™¨ç¸®æ”¾å°è‡´åº§æ¨™åç§»
    canvas.style.width = newWidth + 'px';
    canvas.style.height = newHeight + 'px';
    
    // å‰µå»ºä¸¦ç·©å­˜ ImageData å°è±¡
    imgData = ctx.createImageData(newWidth, newHeight);
    data = new Uint32Array(imgData.data.buffer);
    
    COLS = (canvas.width / SIZE) | 0;
    ROWS = (canvas.height / SIZE) | 0;
    
    if (world.length !== ROWS || (world.length > 0 && world[0].length !== COLS)) {
        initializeWorld();
    }
}

window.addEventListener('resize', resizeCanvas);


/* ===== ç˜‹ç‹‚æ¨¡å¼è®Šæ•¸ (ä¸è®Š) ===== */
let gDir = { x: 0, y: 1 }; 
let crazyModeActive = false;

/* ===== é¡å‹å®šç¾© (T) (ä¸è®Š) ===== */
const T = {
  EMPTY:0, SAND:1, WATER:2, OIL:3,
  WOOD:4, FIRE:5, TNT:6, STONE:7, ACID:8,
  BANANA_BOMB:9, POOP:10, 
  BUTTERFLY:11,
  BENZAMIDE_DERIVATIVE:12, 
  DIRT:13, 
  SEED:14,
  VOID:15,
  TESLA:20, NEWTON:21, CURIE:22, ELON:23,
  EINSTEIN:26, DARWIN:27, EDISON:28, OPPENHEIMER:29,
  LIGHTNING:24, ROCKET:25,
  PRANK_TICKLE: 100, PRANK_SHOCK: 101, PRANK_BLACKHOLE: 102,
  ICE:30, STEAM:31, LAVA:32, MERCURY:33, METHANE:34,
  CEMENT:35, VIRUS:36, ANTIMATTER:37, SPONGE:38, SNOW:39,
  ASH:40, SALT:41, SOAP:42, SLIME:43, GLASS:44,
  BRICK:45, STEEL:46, COAL:47, FUSE:48, DRY_ICE:49,
  PLANT:50, FLOWER:51, VINE:52, MOSS:53, FIREWORK:54,
  CONFETTI:55, GLITTER:56, BONE:57, BLOOD:58, URANIUM:59,
  SPARK:60
};

/* ===== æ•¸æ“š (D) (ä¸è®Š) ===== */
const D = {
  0:{c:"#0b0b0b",d:0, name:"ç©º"},
  1:{c:"#c2b280",d:6,fall:true, name:"æ²™å­"},
  2:{c:"#3399ff",d:5,fluid:true, name:"æ°´"},
  3:{c:"#553311",d:4,fluid:true,flammable:true, name:"æ²¹"},
  4:{c:()=>`#${(0x8B5A2B + Math.floor(Math.random()*10)).toString(16)}`,d:3, static:true, flammable:true, name:"æœ¨é ­", slowBurn:true}, 
  5:{c:"#ffcc33",d:1, fly:true, life:25, name:"ç«"},
  6:{c:"#ff3333",d:10,tnt:true, static:true, flammable:true, name:"TNT"}, 
  7:{c:"#777777",d:7, static:true, name:"çŸ³é ­"},
  8:{c:"#66ff66",d:4,fluid:true,acid:true, name:"é…¸"},
  9:{c:"#ffff66",d:6,banana:true, fall:true, float:true, flammable:true, name:"é¦™è•‰ç‚¸å½ˆ"}, 
  10:{c:"#8B4513",d:5,fall:true, flammable:true, name:"å¤§ä¾¿"},
  11:{c:"#800080",d:0.1, fly:true, flammable:true, name:"å¯¬å°¾é³³è¶äºç¨®è¤æ–‘å¯¬å°¾é³³è¶"},
  12:{c:"#cccccc",d:10, static:true, name:"(S)-N-[2-(N,N-äºŒç•°ä¸™åŸºæ°¨åŸº)ä¹™åŸº]è‹¯ç”²é…°èƒº", immobile: true}, 
  13:{c:"#5a3b2a",d:6, fall:true, name:"æ³¥åœŸ"}, 
  14:{c:"#00aa00",d:5, fall:true, name:"ç¨®å­"},
  15:{c:"#150030",d:100, static:true, name:"è™›ç©º", immobile: true}, 
  20:{c:"#00e0ff",d:5, fall:true, name:"ç‰¹æ–¯æ‹‰", char:true},
  21:{c:"#8eff24",d:5, fall:true, name:"ç‰›é “", char:true},
  22:{c:"#e6ff00",d:5, fall:true, name:"å±…ç¦®å¤«äºº", char:true},
  23:{c:"#ff4500",d:5, fall:true, name:"é¦¬æ–¯å…‹", char:true},
  26:{c:"#aaaaaa",d:5, fall:true, name:"æ„›å› æ–¯å¦", char:true},
  27:{c:"#4caf50",d:5, fall:true, name:"é”çˆ¾æ–‡", char:true},
  28:{c:"#ffcc00",d:5, fall:true, name:"æ„›è¿ªç”Ÿ", char:true},
  29:{c:"#333333",d:5, fall:true, name:"å¥§æœ¬æµ·é»˜", char:true},
  24:{c:"#ffffff",d:0, name:"é–ƒé›»", life:10},
  25:{c:"#ff8800",d:1, name:"ç«ç®­ç«", life:20},
  30:{c:"#aaddff",d:4,fall:true,name:"å†°"},
  31:{c:"#ddeeFF",d:0,fly:true,name:"æ°´è’¸æ°£"},
  32:{c:"#ff4400",d:6,fluid:true,viscous:true,name:"å²©æ¼¿"},
  33:{c:"#b0b0b0",d:15,fluid:true,name:"æ°´éŠ€"},
  34:{c:"#440044",d:0,fly:true,flammable:true,name:"ç”²çƒ·"},
  35:{c:"#999999",d:6,fluid:true,viscous:true,name:"æ°´æ³¥"},
  36:{c:"#88ff88",d:5,fluid:true,name:"ç—…æ¯’"},
  37:{c:"#330000",d:1,fall:true,name:"åç‰©è³ª"},
  38:{c:"#ffff88",d:2,static:true,name:"æµ·ç¶¿"},
  39:{c:"#ffffff",d:2,fall:true,name:"é›ª"},
  40:{c:"#555555",d:2,fall:true,name:"ç°ç‡¼"},
  41:{c:"#eeeeee",d:5,fall:true,name:"é¹½"},
  42:{c:"#ffcccc",d:4,fluid:true,name:"è‚¥çš‚"},
  43:{c:"#00ff00",d:4,fluid:true,name:"å²èŠå§†"},
  44:{c:"#88ccff",d:10,static:true,name:"ç»ç’ƒ"},
  45:{c:"#aa4444",d:10,static:true,name:"ç£šå¡Š"},
  46:{c:"#555577",d:15,static:true,name:"é‹¼éµ"},
  47:{c:"#222222",d:5,fall:true,flammable:true,name:"ç…¤ç‚­"},
  48:{c:"#332211",d:4,static:true,flammable:true,name:"å°ç«ç·š", fuse:true},
  49:{c:"#eeeeff",d:3,fall:true,name:"ä¹¾å†°"},
  50:{c:"#00aa00",d:4,static:true,flammable:true,name:"æ¤ç‰©"},
  51:{c:"#ff66aa",d:4,static:true,name:"èŠ±"},
  52:{c:"#008800",d:4,static:true,name:"è—¤è”“"},
  53:{c:"#448844",d:4,static:true,name:"é’è‹”"},
  54:{c:"#ff00ff",d:5,fall:true,name:"ç…™ç«"},
  55:{c:()=>`#${Math.floor(Math.random()*16777215).toString(16)}`,d:1,fall:true,name:"å½©å¸¶"},
  56:{c:()=>`#${Math.floor(Math.random()*16777215).toString(16)}`,d:3,fall:true,name:"äº®ç²‰"},
  57:{c:"#eeeecc",d:8,static:true,name:"éª¨é ­"},
  58:{c:"#aa0000",d:5,fluid:true,name:"è¡€"},
  59:{c:"#00ff00",d:10,fall:true,name:"éˆ¾"},
   60:{c:"#ffffdd",d:1,life:5,fly:true,name:"ç«èŠ±"},
   100:{c:"#ff69b4",d:0, name:"æƒ¡æ:æ”ç™¢ç¾½æ¯›", tool:true},
  101:{c:"#ffff00",d:0, name:"æƒ¡æ:é›»æ“Šæ§", tool:true},
  102:{c:"#000000",d:0, name:"æƒ¡æ:é»‘æ´", tool:true}
};

/* ===== ä¸–ç•Œç‹€æ…‹ - åˆå§‹åŒ– (ä¸è®Š) ===== */
let world = [];
let bombTimer = {};

function initializeWorld() {
    if (COLS && ROWS) {
        const oldWorld = world;
        const oldRows = oldWorld.length;
        const oldCols = oldWorld.length > 0 ? oldWorld[0].length : 0;
        
        world = Array.from({length:ROWS},(_, y) => 
            Array.from({length:COLS}, (_, x) => {
                if (y < oldRows && x < oldCols) {
                    return oldWorld[y][x]; 
                }
                return T.EMPTY; 
            })
        );
    }
}

function clearWorld() {
    world = Array.from({length:ROWS}, () => Array(COLS).fill(T.EMPTY));
    bombTimer = {};
}

resizeCanvas(); 
initializeWorld();


/* ===== UI å‰µå»ºèˆ‡æ§åˆ¶é‚è¼¯ (ä¸è®Š) ===== */
let tool = T.SAND;
const ui = document.getElementById("ui-scroll");
const crazyModeButton = document.getElementById("crazy-mode-button");
const clearBtn = document.getElementById("clear-btn");
const fullscreenBtn = document.getElementById("fullscreen-btn");

clearBtn.onclick = () => {
    if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å…§å®¹å—ï¼Ÿ")) {
        clearWorld();
    }
};

fullscreenBtn.onclick = () => {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
        });
        fullscreenBtn.textContent = "é€€å‡ºå…¨è¢å¹•";
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
            fullscreenBtn.textContent = "å…¨è¢å¹•";
        }
    }
};

document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
        fullscreenBtn.textContent = "å…¨è¢å¹•";
        // é€€å‡ºå…¨è¢å¹•æ™‚é‡æ–°èª¿æ•´å¤§å°ä»¥ç¢ºä¿æ­£ç¢º
        setTimeout(resizeCanvas, 100);
    } else {
        fullscreenBtn.textContent = "é€€å‡ºå…¨è¢å¹•";
        setTimeout(resizeCanvas, 100);
    }
});

Object.keys(T).forEach(k=>{
  if(k==="EMPTY") return;
  const id = T[k];
  const b=document.createElement("button");
  
  b.textContent=D[id].name; 
  b.style.background=typeof D[id].c === 'function' ? "#8b5a2b" : D[id].c; 

  if (D[id].name.length > 20) {
      b.style.fontSize = '10px';
  } else if (D[id].name.length > 10) {
       b.style.fontSize = '12px';
  }

  b.onclick=()=>{
    tool=id;
    document.querySelectorAll("#ui-scroll button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
  };
  ui.appendChild(b);
});
ui.children[0].classList.add("active");


// ç˜‹ç‹‚æ¨¡å¼æŒ‰éˆ•é‚è¼¯ (ç´”ç²¹æ··äº‚æ¨¡å¼)
crazyModeButton.onclick = () => {
    crazyModeActive = !crazyModeActive;
    crazyModeButton.classList.toggle('active', crazyModeActive);
    if (crazyModeActive) {
        gDir = { x: 0, y: 0 }; 
        crazyModeButton.textContent = "ç˜‹ç‹‚æ¨¡å¼ (æ··äº‚ä¸­...)";
    } else {
        gDir = { x: 0, y: 1 }; 
        crazyModeButton.textContent = "ç˜‹ç‹‚æ¨¡å¼";
    }
};


let brushSize=1;
const brushInput = document.getElementById("brush");
const bvalSpan = document.getElementById("bval");
brushInput.oninput=e=>{
  brushSize=+e.target.value;
  bvalSpan.textContent=brushSize;
};


/* ===== ç¹ªåœ–é‚è¼¯ (ä¸è®Š) ===== */
function inB(x,y){return x>=0&&x<COLS&&y>=0&&y<ROWS}
function paint(x,y){
  if (tool >= 100) {
      if (tool === T.PRANK_TICKLE) {
          for(let dy=-brushSize*2;dy<=brushSize*2;dy++)
            for(let dx=-brushSize*2;dx<=brushSize*2;dx++){
               let tx=x+dx, ty=y+dy;
               if(inB(tx,ty)) {
                   let id = world[ty][tx];
                   if(D[id] && D[id].char) {
                       if(Math.random()<0.3) {
                           const laughs = ["å˜»å˜»ï¼", "å¥½ç™¢ï¼", "åˆ¥é¬§ï¼", "å“ˆå“ˆå“ˆå“ˆï¼"];
                           logMsg(D[id].name, laughs[Math.floor(Math.random()*laughs.length)]);
                           // å‘ä¸Šå½ˆèµ·
                           let jumpH = Math.floor(Math.random()*5)+3;
                           if(inB(tx, ty-jumpH) && world[ty-jumpH][tx] === T.EMPTY) {
                               world[ty-jumpH][tx] = id;
                               world[ty][tx] = T.EMPTY;
                           }
                       }
                   }
               }
            }
          return;
      }
      if (tool === T.PRANK_SHOCK) {
          if(inB(x,y)) world[y][x] = T.LIGHTNING;
          return;
      }
      if (tool === T.PRANK_BLACKHOLE) {
           for(let dy=-brushSize*3;dy<=brushSize*3;dy++)
            for(let dx=-brushSize*3;dx<=brushSize*3;dx++){
               if(inB(x+dx,y+dy)) {
                   if(world[y+dy][x+dx] !== T.VOID) world[y+dy][x+dx]=T.EMPTY;
               }
            }
           return;
      }
  }

  if (tool === T.SEED) {
    for(let dy=0;dy<brushSize;dy++)
      for(let dx=0;dx<brushSize;dx++){
        let currentX = x + dx;
        let currentY = y + dy;
        if(inB(currentX, currentY)) {
             world[currentY][currentX] = T.SEED;
        }
      }
    return;
  }
  
  for(let dy=0;dy<brushSize;dy++)
    for(let dx=0;dx<brushSize;dx++)
      if(inB(x+dx,y+dy)) world[y+dy][x+dx]=tool;
}

function line(x0,y0,x1,y1){
  let dx=Math.abs(x1-x0),dy=Math.abs(y1-y0);
  let sx=x0<x1?1:-1,sy=y0<y1?1:-1,err=dx-dy;
  while(true){
    paint(x0,y0);
    if(x0==x1&&y0==y1)break;
    let e2=2*err;
    if(e2>-dy){err-=dy;x0+=sx}
    if(e2<dx){err+=dx;y0+=sy}
  }
}

let isDrawing=false,lx,ly;

function getPos(e){
  const r=canvas.getBoundingClientRect();
  const p=e.touches?e.touches[0]:e;
  return {x:((p.clientX-r.left)/SIZE)|0,y:((p.clientY-r.top)/SIZE)|0};
}

canvas.onmousedown=e=>{
    isDrawing = true;
    let p=getPos(e); 
    lx=p.x;
    ly=p.y;
    paint(lx, ly); 
}; 

canvas.onmousemove=e=>{
    if(!isDrawing) return;
    if (tool !== T.BUTTERFLY) {
        let p=getPos(e);
        line(lx,ly,p.x,p.y);
        lx=p.x;
        ly=p.y;
    }
};

canvas.onmouseup=canvas.onmouseleave=()=>isDrawing=false;

canvas.ontouchstart=e=>{
    e.preventDefault(); 
    isDrawing = true;
    let p=getPos(e);
    lx=p.x;
    ly=p.y;
    paint(lx, ly); 
}; 

canvas.ontouchmove=e=>{
    e.preventDefault(); 
    if(!isDrawing) return;
    if (tool !== T.BUTTERFLY) {
        let p=getPos(e);
        line(lx,ly,p.x,p.y);
        lx=p.x;
        ly=p.y;
    }
};

canvas.ontouchend=()=>isDrawing=false;

/* ===== çˆ†ç‚¸å‡½æ•¸ (ç§»è‡³ step() ä¸Šæ–¹, è§£æ±º ReferenceError) ===== */
function explode(cx,cy, radius, type){
  const radiusSq = radius * radius;
  for(let y=cy-radius;y<=cy+radius;y++)for(let x=cx-radius;x<=cx+radius;x++){
    if(!inB(x,y))continue;
    
    if((x-cx)**2+(y-cy)**2 < radiusSq){
      let targetID = world[y][x];
      
      if((targetID === T.TNT || targetID === T.BANANA_BOMB) && !bombTimer[x+","+y]) {
        bombTimer[x+","+y]=30; 
      }

      if(targetID === T.BENZAMIDE_DERIVATIVE) {
         world[y][x] = T.EMPTY;
         continue; 
      }

      if(targetID === T.VOID) {
         continue;
      }

      if(targetID !== T.EMPTY){
        world[y][x]=Math.random()<0.4?T.FIRE:T.EMPTY;
      }
    }
  }
  world[cy][cx] = T.EMPTY;
}

/* ===== æ¨¡æ“¬æ­¥é©Ÿ (æ ¸å¿ƒé‚è¼¯ä¸è®Š) ===== */
function step(){
  
  for(let y=ROWS-1;y>=0;y--)for(let x=0;x<COLS;x++){
    let id=world[y][x],d=D[id];
    if(id===0)continue;

    // ç”Ÿå‘½é€±æœŸè¡°æ¸›
    if (d.life && Math.random() < 1/d.life) {
        world[y][x] = T.EMPTY;
        continue;
    }

    let isStatic = d.static;
    
    // éœæ…‹å…ƒç´ äº’å‹•æª¢æŸ¥ (VOID)
    if(isStatic) {
        if (id === T.VOID) {
             for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){
                if(dx===0&&dy===0)continue;
                let xx=x+dx,yy=y+dy;
                if(inB(xx,yy) && world[yy][xx] !== T.EMPTY && world[yy][xx] !== T.VOID) {
                    world[yy][xx] = T.EMPTY;
                }
            }
        }
        
        if (d.immobile) {
            continue;
        }

        if (!crazyModeActive) {
            continue;
        }
    }
    
    /* ç˜‹ç‹‚æ¨¡å¼ï¼šç´”ç²¹éš¨æ©Ÿç§»å‹• */
    if (crazyModeActive && !d.immobile) {
        if(Math.random() < 0.5) continue; 

        let dx = Math.floor(Math.random() * 3) - 1; 
        let dy = Math.floor(Math.random() * 3) - 1; 

        if (dx === 0 && dy === 0) continue; 
        
        let nx=x+dx,ny=y+dy; 
        
        if(inB(nx,ny)){
            let targetID = world[ny][nx];
            if(targetID === T.EMPTY || (D[targetID] && D[targetID].d < d.d && !D[targetID].immobile)) {
                 [world[y][x],world[ny][nx]]=[world[ny][nx],id];
            }
        }
        continue;
    }
    
    // --- æ­£å¸¸æ¨¡å¼ (é‡åŠ›ã€æµé«”ã€ç«ã€é…¸ã€çˆ†ç‚¸) å¾æ­¤è™•ç¹¼çºŒ ---

    /* === æ–°å¢ç‰©å“è¡Œç‚ºé‚è¼¯ === */
    // å²©æ¼¿ (LAVA)
    if (id === T.LAVA) {
        if (Math.random() < 0.05) {
            const rx = x + Math.floor(Math.random()*3)-1;
            const ry = y + Math.floor(Math.random()*3)-1;
            if (inB(rx, ry)) {
                const tid = world[ry][rx];
                if (tid === T.WATER) {
                    world[y][x] = T.STONE; // å†·å»
                    world[ry][rx] = T.STEAM; // è’¸ç™¼
                } else if (tid === T.ICE || tid === T.SNOW) {
                    world[ry][rx] = T.WATER;
                } else if (D[tid] && D[tid].flammable) {
                    world[ry][rx] = T.FIRE;
                }
            }
        }
    }
    
    // å†° (ICE) / é›ª (SNOW) / ä¹¾å†° (DRY_ICE)
    if (id === T.ICE || id === T.SNOW || id === T.DRY_ICE) {
        if (Math.random() < 0.005) {
            if (id === T.DRY_ICE) world[y][x] = T.METHANE; // æ˜‡è¯
            else if (inB(x, y+1) && world[y+1][x] === T.FIRE) world[y][x] = T.WATER; // å—ç†±èåŒ–
            else if (Math.random() < 0.0001) world[y][x] = T.WATER; // è‡ªç„¶èåŒ–
        }
    }

    // æ°´è’¸æ°£ (STEAM)
    if (id === T.STEAM) {
        if (Math.random() < 0.01) {
            world[y][x] = T.WATER; // å‡çµ
        }
    }
    
    // æ°´æ³¥ (CEMENT)
    if (id === T.CEMENT) {
        if (Math.random() < 0.005) {
            world[y][x] = T.STONE; // ç¡¬åŒ–
        }
    }
    
    // ç—…æ¯’ (VIRUS)
    if (id === T.VIRUS) {
        if (Math.random() < 0.1) {
            const rx = x + Math.floor(Math.random()*3)-1;
            const ry = y + Math.floor(Math.random()*3)-1;
            if (inB(rx, ry)) {
                const tid = world[ry][rx];
                if (tid === T.PLANT || tid === T.FLOWER || tid === T.VINE || tid === T.WOOD || (D[tid] && D[tid].char)) {
                    world[ry][rx] = T.SLIME;
                }
            }
        }
    }
    
    // åç‰©è³ª (ANTIMATTER)
    if (id === T.ANTIMATTER) {
         for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){
            if (dx===0 && dy===0) continue;
            let nx=x+dx, ny=y+dy;
            if (inB(nx, ny) && world[ny][nx] !== T.EMPTY && world[ny][nx] !== T.ANTIMATTER) {
                world[ny][nx] = T.EMPTY;
                world[y][x] = T.EMPTY; // æ¹®æ»…
                if(Math.random()<0.5) explode(x,y, 3, T.TNT);
                break; 
            }
         }
    }

    // æµ·ç¶¿ (SPONGE)
    if (id === T.SPONGE) {
         for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){
            let nx=x+dx, ny=y+dy;
            if (inB(nx, ny) && world[ny][nx] === T.WATER) {
                world[ny][nx] = T.EMPTY; // å¸æ°´
            }
         }
    }
    
    // æ¤ç‰©ç”Ÿé•· (PLANT, VINE)
    if ((id === T.PLANT || id === T.VINE) && Math.random() < 0.02) {
        let waterNearby = false;
        for(let dy=-2;dy<=2;dy++)for(let dx=-2;dx<=2;dx++){
            if(inB(x+dx, y+dy) && world[y+dy][x+dx] === T.WATER) {
                waterNearby = true;
                if(Math.random()<0.1) world[y+dy][x+dx] = T.EMPTY; 
            }
        }
        
        if (waterNearby) {
            let gx = x + Math.floor(Math.random()*3)-1;
            let gy = y - 1; 
            if (id === T.VINE) gy = y + Math.floor(Math.random()*3)-1; 
            
            if (inB(gx, gy) && world[gy][gx] === T.EMPTY) {
                world[gy][gx] = id === T.PLANT && Math.random()<0.2 ? T.FLOWER : id;
            }
        }
    }
    
    // ç…™ç« (FIREWORK)
    if (id === T.FIREWORK) {
        if (Math.random() < 0.2 && inB(x, y-1) && world[y-1][x] === T.EMPTY) {
             world[y-1][x] = T.FIREWORK; 
             world[y][x] = T.EMPTY; 
             continue;
        }
        if (Math.random() < 0.05) {
             explode(x, y, 5, T.TNT); 
             for(let dy=-3;dy<=3;dy++)for(let dx=-3;dx<=3;dx++){
                 if(inB(x+dx, y+dy) && world[y+dy][x+dx] === T.EMPTY && Math.random()<0.3) {
                     world[y+dy][x+dx] = Math.random()<0.5 ? T.CONFETTI : T.GLITTER;
                 }
             }
             world[y][x] = T.EMPTY;
        }
    }

    // éˆ¾ (URANIUM)
    if (id === T.URANIUM) {
        if (Math.random() < 0.02) {
             const rx = x + Math.floor(Math.random()*3)-1;
             const ry = y + Math.floor(Math.random()*3)-1;
             if (inB(rx, ry) && world[ry][rx] === T.EMPTY) {
                 world[ry][rx] = T.FIRE; 
             }
        }
    }

    /* === çŸ¥åäººç‰©è¡Œç‚º === */
    if (d.char) {
        // éš¨æ©Ÿèªªè©±
        if (Math.random() < 0.005) {
             const msgs = {
                 [T.TESLA]: ["äº¤æµé›»æ‰æ˜¯æœªä¾†ï¼", "ç„¡é™èƒ½é‡ï¼", "å°å¿ƒé«˜å£“é›»ï¼", "æ„›è¿ªç”Ÿæ˜¯å¤§ç¬¨è›‹ï¼"],
                 [T.NEWTON]: ["è˜‹æœåœ¨å“ªï¼Ÿ", "è¬æœ‰å¼•åŠ›...", "å¾®ç©åˆ†æ˜¯æˆ‘ç™¼æ˜çš„ï¼", "ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€‚"],
                 [T.CURIE]: ["é€™å…‰èŠ’çœŸç¾...", "ç§‘å­¸éœ€è¦çŠ§ç‰²ã€‚", "é³çš„åŠ›é‡ã€‚", "æœ‰é»æšˆ..."],
                 [T.ELON]: ["ç«æ˜Ÿæˆ‘ä¾†äº†ï¼", "è‚¡åƒ¹åˆæ¼²äº†ã€‚", "Doge to the moon!", "å…¨è‡ªå‹•é§•é§›æ˜å¹´å°±å‡ºï¼"],
                 [T.EINSTEIN]: ["E=mcÂ²", "æ™‚é–“æ˜¯ç›¸å°çš„ã€‚", "ä¸Šå¸ä¸æ“²éª°å­ã€‚", "æƒ³åƒåŠ›æ¯”çŸ¥è­˜é‡è¦ã€‚"],
                 [T.DARWIN]: ["ç‰©ç«¶å¤©æ“‡ã€‚", "é©è€…ç”Ÿå­˜ã€‚", "æ¼”åŒ–...", "é€™éš»é³¥çš„å–™å¾ˆæœ‰è¶£ã€‚"],
                 [T.EDISON]: ["å¤©æ‰æ˜¯ä¸€åˆ†éˆæ„Ÿ...", "æˆ‘æ²’æœ‰å¤±æ•—ï¼Œåªæ˜¯ç™¼ç¾äº†...", "äº¤æµé›»å¾ˆå±éšªï¼", "æˆ‘è¦ç”³è«‹å°ˆåˆ©ï¼"],
                 [T.OPPENHEIMER]: ["æˆ‘æˆç‚ºäº†æ­»ç¥...", "ä¸–ç•Œçš„æ¯€æ»…è€…ã€‚", "éˆå¼åæ‡‰ã€‚", "Boom!"]
             };
             const list = msgs[id] || ["..."];
             logMsg(d.name, list[Math.floor(Math.random()*list.length)]);
        }

        // ç§»å‹•é‚è¼¯ (é¡ä¼¼è´è¶ä½†å—é‡åŠ›)
        // åªæœ‰ 10% æ©Ÿç‡ç§»å‹•ï¼Œé¿å…éå¿«
        if (Math.random() < 0.1) {
            let dx = Math.random() < 0.5 ? 1 : -1;
            
            // ç‰¹æ®ŠæŠ€èƒ½
            if (id === T.TESLA && Math.random() < 0.2) {
                 // é–ƒé›»æ”»æ“Š
                 const tx = x + (Math.random()<0.5?1:-1) * (Math.floor(Math.random()*3)+1);
                 const ty = y + (Math.floor(Math.random()*3)-1);
                 if (inB(tx, ty) && world[ty][tx] === T.EMPTY) {
                     world[ty][tx] = T.LIGHTNING;
                 }
            }
            else if (id === T.NEWTON && Math.random() < 0.2) {
                 // é‡åŠ›å ´ï¼šå¸å–ä¸Šæ–¹ç‰©é«”
                 for(let i=1; i<5; i++) {
                     if(inB(x, y-i) && world[y-i][x] !== T.EMPTY && D[world[y-i][x]].fall) {
                         // å°‡ä¸Šæ–¹ç‰©é«”æ‹‰åˆ°èº«é‚Šç©ºä½
                         if(inB(x+1, y) && world[y][x+1] === T.EMPTY) world[y][x+1] = world[y-i][x];
                         else if(inB(x-1, y) && world[y][x-1] === T.EMPTY) world[y][x-1] = world[y-i][x];
                         world[y-i][x] = T.EMPTY;
                         break;
                     }
                 }
            }
            else if (id === T.CURIE && Math.random() < 0.05) {
                 // è¼»å°„
                 for(let dy=-1; dy<=1; dy++) for(let dx=-1; dx<=1; dx++) {
                     if(dx===0&&dy===0) continue;
                     const tx=x+dx, ty=y+dy;
                     if(inB(tx, ty) && world[ty][tx] !== T.EMPTY && world[ty][tx] !== T.VOID && world[ty][tx] !== T.ACID) {
                          if(Math.random()<0.1) world[ty][tx] = T.ACID;
                     }
                 }
            }
            else if (id === T.ELON && Math.random() < 0.1) {
                 // ç™¼å°„ç«ç®­
                 if(inB(x, y-1) && world[y-1][x] === T.EMPTY) {
                     world[y-1][x] = T.ROCKET;
                 }
            }
            else if (id === T.EINSTEIN && Math.random() < 0.02) {
                // é‡å­ç©¿éš§ (éš¨æ©Ÿå‚³é€)
                let tx = Math.floor(Math.random() * COLS);
                let ty = Math.floor(Math.random() * ROWS);
                if (world[ty][tx] === T.EMPTY) {
                     world[ty][tx] = id;
                     world[y][x] = T.EMPTY;
                     continue;
                }
            }
            else if (id === T.DARWIN && Math.random() < 0.05) {
                // æ¼”åŒ–ï¼šå°‡æ³¥åœŸè®Šç¨®å­ï¼Œæ°´è®Šé…¸(åŸå§‹æ¹¯)
                 for(let dy=-1; dy<=1; dy++) for(let dx=-1; dx<=1; dx++) {
                     if(dx===0&&dy===0) continue;
                     const tx=x+dx, ty=y+dy;
                     if(inB(tx, ty)) {
                         if(world[ty][tx] === T.DIRT) world[ty][tx] = T.SEED;
                         else if(world[ty][tx] === T.WATER && Math.random()<0.1) world[ty][tx] = T.ACID; 
                     }
                 }
            }
            else if (id === T.EDISON && Math.random() < 0.1) {
                // ç‡ˆæ³¡ (ç”Ÿæˆå°ç«èŠ±)
                if(inB(x, y-1) && world[y-1][x] === T.EMPTY) {
                    world[y-1][x] = T.FIRE;
                }
                // å¸æ”¶é–ƒé›»
                for(let dy=-2; dy<=2; dy++) for(let dx=-2; dx<=2; dx++) {
                     const tx=x+dx, ty=y+dy;
                     if(inB(tx, ty) && world[ty][tx] === T.LIGHTNING) {
                         world[ty][tx] = T.EMPTY;
                     }
                 }
            }
            else if (id === T.OPPENHEIMER && Math.random() < 0.005) {
                // æ¯€æ»…è€… (ç”ŸæˆTNT)
                if(inB(x, y-1) && world[y-1][x] === T.EMPTY) {
                    world[y-1][x] = T.TNT;
                }
            }

            // å·¦å³èµ°å‹•
            const nx = x + dx;
            if(inB(nx, y) && world[y][nx] === T.EMPTY) {
                 world[y][nx] = id;
                 world[y][x] = T.EMPTY;
                 // ç§»å‹•å¾Œè·³éæœ¬å¹€å¾ŒçºŒè™•ç† (é›–ç„¶ x è®Šäº†ä½† y æ²’è®Šï¼Œæœ¬è¡Œå·²è™•ç†å®Œ)
                 // ä½†ç‚ºäº†å®‰å…¨
                 continue;
            }
        }
    }

    // é–ƒé›»/ç«ç®­ç”Ÿå‘½é€±æœŸ
    if (d.life) {
        if (Math.random() < 0.1) {
            world[y][x] = T.EMPTY;
            continue;
        }
        if (id === T.ROCKET) {
             // å‘ä¸Šé£› (ç‚ºäº†é˜²æ­¢ç¬é–“é£›å¤©ï¼Œæˆ‘å€‘åªåœ¨å¶æ•¸å¹€æˆ–ä½æ©Ÿç‡é£›)
             if (Math.random() < 0.2 && inB(x, y-1)) {
                 if (world[y-1][x] === T.EMPTY) {
                     world[y-1][x] = T.ROCKET;
                     world[y][x] = T.FIRE; // å°¾è·¡
                     continue;
                 } else {
                     // æ’åˆ°æ±è¥¿çˆ†ç‚¸
                     explode(x, y, 3, T.TNT);
                 }
             }
        }
        if (id === T.LIGHTNING) {
            // éš¨æ©Ÿäº‚ç«„
            const dx = Math.floor(Math.random()*3)-1;
            const dy = Math.floor(Math.random()*3)-1;
            const nx=x+dx, ny=y+dy;
            if(inB(nx,ny) && world[ny][nx] !== T.LIGHTNING) {
                if(world[ny][nx] !== T.EMPTY) {
                    // é›»æ“Šç ´å£
                    world[ny][nx] = T.FIRE;
                } else {
                    world[ny][nx] = T.LIGHTNING;
                    world[y][x] = T.EMPTY;
                }
                continue;
            }
        }
    }

    /* è´è¶ (BUTTERFLY) è¡Œç‚º (ç•¥) */
    if(id === T.BUTTERFLY) {
        if (Math.random() < 0.5) {
            continue; 
        }
        let dx = Math.random() < 0.33 ? 1 : (Math.random() < 0.5 ? -1 : 0);
        let dy = Math.random() < 0.8 ? 0 : -1;
        if(Math.random() < 0.05) dy = 1;

        let nx=x+dx,ny=y+dy;
        
        if(inB(nx,ny)){
            let targetID = world[ny][nx];
            if(targetID === T.EMPTY || (D[targetID] && D[targetID].d < d.d)) {
                 [world[y][x],world[ny][nx]]=[world[ny][nx],id];
            } else {
                 if(Math.random() < 0.005) world[y][x] = T.EMPTY; 
            }
        }
        continue;
    }
    
    /* ç¨®å­ (SEED) è¡Œç‚º */
    if(id === T.SEED) {
        // ...
    }

    /* é‡åŠ›èˆ‡å¯†åº¦/æ¼‚æµ® */
    let dy = gDir.y;
    let isRising = false;
    if (d.fly) {
        dy = -1; 
        isRising = true;
        // ç‚ºäº†é¿å…å‘ä¸Šç§»å‹•æ™‚å› æƒæé †åºå°è‡´çš„ç¬é–“å‚³é€(Teleport)ï¼Œé™ä½ç§»å‹•æ©Ÿç‡
        if(Math.random() < 0.7) dy = 0; 
    }

    let nx=x+gDir.x,ny=y+dy; 
    
    let swap = false;
    if(inB(nx,ny)){
        let targetID = world[ny][nx];
        let targetD = D[targetID];
        
        if (!targetD) {
             continue;
        }

        if (targetD.static) {
             swap = false; 
        }
        else if (targetID === T.EMPTY) {
            swap = true;
        } 
        else if (isRising) {
            // ä¸Šå‡ï¼šå¦‚æœä¸Šæ–¹ç‰©é«”æ¯”æˆ‘é‡ï¼Œäº¤æ› (æµ®åŠ›)
            if (targetD.d > d.d) swap = true;
        }
        else {
            // ä¸‹é™ï¼šå¦‚æœä¸‹æ–¹ç‰©é«”æ¯”æˆ‘è¼•ï¼Œäº¤æ› (é‡åŠ›)
            if (targetD.d < d.d) swap = true;
            
            // æ¶²é«”æ··åˆå„ªåŒ–
            if (d.fluid && targetD.fluid && d.d > targetD.d) swap = true;
        }

        if (swap) {
            [world[y][x],world[ny][nx]]=[world[ny][nx],id];
            continue;
        }
    }

    /* æµé«”æ©«å‘ç§»å‹• */
    if(d.fluid){
      if (d.viscous && Math.random() < 0.9) continue; // é»ç¨ æ¶²é«”æµå‹•ç·©æ…¢
      if (gDir.x !== 0 && Math.random() < 0.2) continue;
      
      let dir=Math.random()<0.5?-1:1;
      let sx=x+dir;
      if(inB(sx,y)&&world[y][sx]===T.EMPTY){ 
        world[y][sx]=id; world[y][x]=0;
      }
    }

    /* ç« / ç«èŠ± è¡Œç‚º */
    if(id===T.FIRE || id===T.SPARK){
      for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){
        let xx=x+dx,yy=y+dy;
        if(!inB(xx,yy))continue;
        
        let targetID = world[yy][xx];
        let targetD = D[targetID]; 
        
        if (!targetD) continue;

        // ç«èŠ±å¼•ç‡ƒå°ç«ç·š
        if (targetD.fuse) {
            world[yy][xx] = T.SPARK;
            continue;
        }

        if(targetD.flammable) {
            let burnChance = 0.1; 
            if (id === T.SPARK) burnChance = 0.5; // ç«èŠ±å¼•ç‡ƒç‡æ›´é«˜

            if (targetD.slowBurn) { 
                burnChance = 0.01;
            } 
            if (targetD.tnt || targetID === T.FIREWORK) {
                burnChance = 0.8; // ç‚¸è—¥æ¥µæ˜“å¼•ç‡ƒ
            }

            if (Math.random() < burnChance) {
                 world[yy][xx]=T.FIRE;
            }
        }
        
        if((targetID===T.TNT||targetID===T.BANANA_BOMB)&&!bombTimer[xx+","+yy]) 
            bombTimer[xx+","+yy]=40; 
        
        if(targetID===T.WATER) {
             if(Math.random()<0.04) world[y][x]=0; 
             if(Math.random()<0.1) world[yy][xx]=T.STEAM; // æ°´ç…®æ²¸
        }
      }
    }

    /* ç«èŠ±ç§»å‹• */
    if (id === T.SPARK) {
        if(Math.random()<0.5 && inB(x, y-1) && world[y-1][x]===T.EMPTY) {
            world[y-1][x] = T.SPARK;
            world[y][x] = T.EMPTY;
        }
    }

    /* é…¸ */
    if(id===T.ACID){
      for(let dy=0;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){
        let xx=x+dx,yy=y+dy;
        if(!inB(xx,yy))continue; 

        let targetID = world[yy][xx];
        
        if(targetID!==T.ACID && targetID!==T.EMPTY && D[targetID] && Math.random()<0.05) {
             world[yy][xx]=0; // è…è•
             // ç”¢ç”Ÿç…™éœ§/æ°£é«”
             if (Math.random() < 0.3 && inB(xx, yy-1) && world[yy-1][xx] === T.EMPTY) {
                 world[yy-1][xx] = T.METHANE;
             }
        }
      }
    }

    /* TNT / é¦™è•‰ç‚¸å½ˆ (çˆ†ç‚¸è¨ˆæ™‚) (ç•¥) */
    if(id===T.TNT || id===T.BANANA_BOMB){
      let k=x+","+y;
      let fuseTime;
      let explosionRadius;
      
      if (id === T.TNT) {
          fuseTime = 60;
          explosionRadius = 7;
      } else if (id === T.BANANA_BOMB) {
          fuseTime = 40;
          explosionRadius = 6;
      }
      
      bombTimer[k]=(bombTimer[k]||fuseTime)-1;
      
      if(bombTimer[k]<=0){
        explode(x,y, explosionRadius, id);
        delete bombTimer[k];
      }
    }
  }
}


/* ===== ç¹ªè£½ ===== */
// é å…ˆè¨ˆç®—é¡è‰²ç·©å­˜ (Int32)
const colorCache = {};

function parseColor(hex) {
    if (typeof hex === 'function') return null; // æš«ä¸ç·©å­˜å‹•æ…‹é¡è‰²
    if (!hex.startsWith('#')) return 0xFF000000;
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return (255 << 24) | (b << 16) | (g << 8) | r; // ABGR for Little Endian
}

// è§’è‰²ç¬¦è™Ÿæ˜ å°„
const charSprites = {
    [T.TESLA]: "âš¡",
    [T.NEWTON]: "ğŸ",
    [T.CURIE]: "â˜¢ï¸",
    [T.ELON]: "ğŸš€",
    [T.EINSTEIN]: "ğŸ§ ",
    [T.DARWIN]: "ğŸ’",
    [T.EDISON]: "ğŸ’¡",
    [T.OPPENHEIMER]: "ğŸ’£"
};

let lastTime = performance.now();
let frames = 0;
const fpsDiv = document.getElementById("fps-counter");

function draw(){
  if (COLS === 0 || ROWS === 0) return; 
  
  // è¨ˆç®— FPS
  frames++;
  const now = performance.now();
  if (now - lastTime >= 1000) {
      fpsDiv.textContent = `FPS: ${frames}`;
      frames = 0;
      lastTime = now;
  }

  // ä½¿ç”¨ ImageData å„ªåŒ–æ¸²æŸ“
  // imgData å’Œ data å·²åœ¨ resizeCanvas ä¸­åˆå§‹åŒ–
  // æ¸…ç©º data ç·©è¡å€ (å…¨é»‘/é€æ˜) - å¦‚æœæ¯ä¸€å¹€éƒ½å…¨è¦†è“‹ï¼Œé€™ä¸€æ­¥å¯çœç•¥ï¼Œä½†ç‚ºäº†ä¿éšªå…ˆæ¸…ç©º
  // 0xFF000000 æ˜¯ä¸é€æ˜é»‘è‰² (ABGR)ï¼Œå¦‚æœæ˜¯é€æ˜å‰‡ç‚º 0
  // ç”±æ–¼æˆ‘å€‘èƒŒæ™¯è‰²æ˜¯ #0b0b0b -> R=11, G=11, B=11 -> ABGR = FF0B0B0B
  // ç‚ºäº†æœ€å¿«é€Ÿåº¦ï¼Œå¯ä»¥ç”¨ fill
  data.fill(0xFF0B0B0B); 
  
  // å¡«å……èƒŒæ™¯èˆ‡ç²’å­
  for(let y=0;y<ROWS;y++) {
      for(let x=0;x<COLS;x++){
        let id = world[y][x];
        if (id === 0) continue; // è·³éç©ºåƒç´ ï¼Œä¿ç•™èƒŒæ™¯è‰²

        let d = D[id];
        let colVal;

        if (d.char) {
             // è§’è‰²å„ªåŒ–ï¼šä¸ç¹ªè£½åº•å±¤æ–¹å¡Šé¡è‰²ï¼Œåªç¹ªè£½ Sprite
             // è¨­ç½®ç‚ºèƒŒæ™¯è‰² (é€æ˜/é»‘è‰²)
             colVal = 0xFF0B0B0B;
        }
        else if (typeof d.c === 'function') {
             // å‹•æ…‹é¡è‰² (å¦‚æœ¨é ­) éœ€å¯¦æ™‚è§£æï¼Œæ•ˆèƒ½ç¨å·®ä½†å¿…è¦
             // é€™è£¡ç°¡åŒ–ï¼šåªå–ä¸€å€‹å›ºå®šè‰²æˆ–é‡æ–°è§£æ
             // ç‚ºäº†æ•ˆèƒ½ï¼Œé€™è£¡æš«æ™‚ä½¿ç”¨å›ºå®šè¿‘ä¼¼è‰²ï¼Œæˆ–è€…è§£æå‡½æ•¸è¿”å›å€¼
             // ä½†åŸé‚è¼¯æ¯æ¬¡éƒ½è®Šè‰²ï¼Œé€™è£¡ç‚ºäº† ImageData æ•ˆèƒ½ï¼Œæˆ‘å€‘éœ€è¦è½‰æ›
             let cStr = d.c();
             let r = parseInt(cStr.slice(1, 3), 16);
             let g = parseInt(cStr.slice(3, 5), 16);
             let b = parseInt(cStr.slice(5, 7), 16);
             colVal = (255 << 24) | (b << 16) | (g << 8) | r;
        } else {
             if (!colorCache[id]) colorCache[id] = parseColor(d.c);
             colVal = colorCache[id];
        }

        // å¡«å…… 4x4 å€å¡Š (SIZE=4)
        const baseIdx = (y * SIZE * canvas.width) + (x * SIZE);
        for(let dy=0; dy<SIZE; dy++) {
            const rowOffset = baseIdx + dy * canvas.width;
            for(let dx=0; dx<SIZE; dx++) {
                data[rowOffset + dx] = colVal;
            }
        }
      }
  }
  
  ctx.putImageData(imgData, 0, 0);

  // ç¬¬äºŒå±¤ï¼šç¹ªè£½è§’è‰² Sprite (Emoji)
  ctx.font = "12px sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  
  for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++){
      let id = world[y][x];
      if (D[id].char && charSprites[id]) {
          // åœ¨ç²’å­ä¸Šæ–¹ç¹ªè£½ Emoji
          const cx = x * SIZE + SIZE/2;
          const cy = y * SIZE + SIZE/2 + 1; // å¾®èª¿å‚ç›´ä½ç½®
          ctx.fillStyle = "#FFFFFF";
          // ç‚ºäº†è®“ Emoji çœ‹å¾—æ¸…æ¥šï¼Œå¯ä»¥åŠ å€‹é™°å½±
          ctx.shadowColor="black";
          ctx.shadowBlur=2;
          ctx.fillText(charSprites[id], cx, cy);
          ctx.shadowBlur=0;
      }
  }
}

/* ===== å¾ªç’° (ç•¥) ===== */
(function loop(){
  step();
  draw();
  requestAnimationFrame(loop);
})();

function logMsg(name, msg) {
    const log = document.getElementById('game-log');
    const div = document.createElement('div');
    div.className = 'log-msg';
    div.innerHTML = `<span class="log-name">${name}:</span> ${msg}`;
    log.prepend(div);
    if(log.children.length > 10) log.lastChild.remove();
}
</script>
</body>
</html>
